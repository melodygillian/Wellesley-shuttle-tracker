<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wellesley Shuttle Finder</title>
<style>
  :root {
    --champagne: #F7E7CE;
    --pearl-gray: #DCD7D1;
    --olive-gray: #919b87;
    --soph-gray: #5a595e;
    --dusty-pink: #D8A7B1;
    --coral: #FF7F50;
    --tiff-blue: #0ABAB5;
    --burgundy: #800020;
    --soft-pink: #F2CEDD;
  }
  body {
    background: var(--champagne);
    color: var(--soph-gray);
    font-family: 'Avenir', 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    min-height: 100vh;
  }
  .container {
    background: var(--pearl-gray);
    max-width: 470px;
    margin: 28px auto;
    border-radius: 18px;
    box-shadow: 0 4px 12px rgb(145 155 135 / 16%);
    padding: 32px 20px;
  }
  h1 {
    color: var(--olive-gray);
    font-weight: 700;
    font-size: 1.5em;
    margin-bottom: 16px;
    text-align: center;
  }
  #now {
    background: var(--soft-pink);
    color: var(--burgundy);
    border-radius: 8px;
    padding: 12px 14px;
    font-size: 1.1em;
    margin-bottom: 18px;
    text-align: center;
    font-weight: 600;
  }
  .info, .result, #schedule {
    margin-bottom: 18px;
    font-size: 1.02em;
  }
  .result {
    background: var(--champagne);
    padding: 14px 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgb(250 128 114 / 10%);
    font-size: 1.15em;
    font-weight: 600;
    color: var(--burgundy);
  }
  .label {
    color: var(--tiff-blue);
    font-weight: 700;
  }
  .walk-time {
    color: var(--coral);
    font-weight: 500;
    margin-top: 6px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 14px;
    background: var(--soft-pink);
    border-radius: 6px;
    overflow: hidden;
  }
  th, td {
    padding: 8px 6px;
    border: 1px solid var(--dusty-pink);
    font-size: 0.95em;
    text-align: center;
  }
  th {
    background: var(--dusty-pink);
    color: var(--burgundy);
    font-weight: 700;
  }
  footer {
    color: var(--soph-gray);
    text-align: center;
    font-size: 0.8em;
    margin-top: 24px;
    opacity: 0.7;
  }
  @media (max-width: 440px) {
    .container { max-width: 95vw; padding: 12vw 3vw;}
    table { font-size: 0.85em; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>Wellesley Shuttle Finder</h1>
  <div id="now"></div>
  <div class="info" id="status">Detecting location and schedule&hellip;</div>
  <div class="result" id="result"></div>
  <div id="schedule"></div>
</div>
<footer>
  Wellesley Shuttle schedules in Morandi colors â€¢ Anonymous & privacy-focused
</footer>
<script>
  // Shuttle stops with lat/lon, tagged as campus or off campus
  const stops = {
    "Chapel_out": {lat: 42.293849, lon: -71.305063, type: "campus", label:"Chapel (Outbound)"},
    "Alumnae_out": {lat: 42.295392, lon: -71.303625, type: "campus", label:"Alumnae (Outbound)"},
    "Harvard Sq.": {lat: 42.373605, lon: -71.109733, type: "off"},
    "77 Mass Ave.": {lat: 42.360058, lon: -71.093228, type: "off"},
    "Marlboro Market": {lat: 42.34861, lon: -71.05808, type: "off"},
    "Alumnae_in": {lat: 42.295392, lon: -71.303625, type: "campus", label:"Alumnae (Inbound)"},
    "Chapel_in": {lat: 42.293849, lon: -71.305063, type: "campus", label:"Chapel (Inbound)"}
  };

  // The shuttle schedules with outbound and inbound stops for Chapel and Alumnae
  // Times are examples from official schedule truncated for brevity

  const sundaySenate = [
    {bus: "A", stopTimes: {
      "Chapel_out":"9:00 am", "Alumnae_out":"9:05 am",
      "Harvard Sq.":"9:45 am", "77 Mass Ave.":"9:55 am", "Marlboro Market":"10:00 am",
      "Alumnae_in":"10:30 am", "Chapel_in":"10:35 am"
    }},
    {bus: "A", stopTimes: {
      "Chapel_out":"11:00 am", "Alumnae_out":"11:05 am",
      "Harvard Sq.":"11:45 am", "77 Mass Ave.":"11:55 am", "Marlboro Market":"12:00 pm",
      "Alumnae_in":"12:30 pm", "Chapel_in":"12:35 pm"
    }},
    /* more trips */
  ];

  // Similarly other schedules...

  // For simplicity, let's show only Sunday schedule in example,
  // but you can extend all weekday, saturday, and friday schedules similarly

  // Helper functions
  function timeToMinutes(t) {
    if (!t) return null;
    let [time, meridiem] = t.toLowerCase().split(' ');
    let [h, m] = time.split(':').map(Number);
    if(meridiem === 'pm' && h !== 12) h += 12;
    if(meridiem === 'am' && h === 12) h = 0;
    return h*60 + m;
  }
  function nowMinutes() {
    let d = new Date();
    return d.getHours()*60 + d.getMinutes();
  }
  function distanceKm(lat1, lon1, lat2, lon2) {
    const R=6371;
    const dLat=(lat2 - lat1) * (Math.PI/180);
    const dLon=(lon2 - lon1) * (Math.PI/180);
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * (Math.PI/180)) *
              Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }
  function walkingMinutes(distance) {
    return Math.round(distance / 5 * 60);
  }
  function formatDatetime() {
    return (new Date()).toLocaleString("en-US", {weekday:"long", year:"numeric", month:"long", day:"numeric", hour:"2-digit", minute:"2-digit", hour12:true});
  }

  // Determine if user is on campus roughly (within 1 km of Chapel_out)
  function userIsOnCampus(lat, lon) {
    const chapel = stops["Chapel_out"];
    const dist = distanceKm(lat, lon, chapel.lat, chapel.lon);
    return dist < 1.0;
  }
  // Find closest stop and bound stop name based on user position
  function findClosestStop(lat, lon, onCampus) {
    let minDist = Infinity, closestStop = null;
    for (const [key, stop] of Object.entries(stops)) {
      // Filter stops by route direction user would be interested in
      if (onCampus && (key.endsWith("_in"))) continue; // On campus user cares about outbound only
      if (!onCampus && (key.endsWith("_out"))) continue; // Off campus user cares about inbound only
      const dist = distanceKm(lat, lon, stop.lat, stop.lon);
      if (dist < minDist) {
        minDist = dist;
        closestStop = { key, stop, dist };
      }
    }
    return closestStop;
  }
  // Get next bus coming to the stop for given schedule array
  function getNextBus(schedule, stopName) {
    const now = nowMinutes();
    let nextBus = null;
    let minTime = Infinity;

    for (const trip of schedule) {
      const t = timeToMinutes(trip.stopTimes[stopName]);
      if (t !== null && t >= now && t < minTime) {
        minTime = t;
        nextBus = { bus: trip.bus, time: trip.stopTimes[stopName], stopName };
      }
    }
    return nextBus;
  }
  // Build full trip table with named stops and columns in order
  function buildScheduleTable(schedule, onCampus) {
    // Ordered stops fully showing outbound and inbound at start and end
    const orderedStops = [
      "Chapel_out",
      "Alumnae_out",
      "Harvard Sq.",
      "77 Mass Ave.",
      "Marlboro Market",
      "Alumnae_in",
      "Chapel_in"
    ];
    // Display stop headers with clearer labels
    const headers = orderedStops.map(s=>stops[s]?.label || s).join('</th><th>');
    let table = '<table><thead><tr><th>Bus</th><th>' + headers + '</th></tr></thead><tbody>';
    for(const trip of schedule) {
      table += '<tr><td>' + trip.bus + '</td>';
      for(const stopName of orderedStops) {
        table += '<td>' + (trip.stopTimes[stopName] || '') + '</td>';
      }
      table += '</tr>';
    }
    table += '</tbody></table>';
    return table;
  }

  // Main logic - called with user location lat/lon
  function main(lat, lon) {
    const nowStr = formatDatetime();
    document.getElementById('now').textContent = `Today is ${nowStr}`;
    const onCampus = userIsOnCampus(lat, lon);
    const closest = findClosestStop(lat, lon, onCampus);

    document.getElementById('status').innerHTML = `Location detected. You appear to be <strong>${onCampus ? "on campus" : "off campus"}</strong>. Closest stop is <strong>${closest.stop.label || closest.key}</strong>, ~${closest.dist.toFixed(2)} km away (~${walkingMinutes(closest.dist)} min walk).`;

    // We'll just show sundaySenate for demo; expand to all days logic
    const scheduleToday = sundaySenate; // For demo replace with day detection logic

    // For on campus user, find next outbound trip time at Chapel_out or Alumnae_out, else inbound for off campus
    let stopNameForNextBus = closest.key;
    const nextBus = getNextBus(scheduleToday, stopNameForNextBus);

    let resultHtml;
    if (nextBus) {
      resultHtml = `<div><span class="label">Next bus:</span> Bus ${nextBus.bus} at <span class="label">${nextBus.time}</span> (Stop: <span class="label">${nextBus.stopName}</span>)</div>`;
    } else {
      resultHtml = `<div>No more buses today for stop <span class="label">${stopNameForNextBus}</span>.</div>`;
    }
    resultHtml += `<div class="walk-time">Estimated walking time: ${walkingMinutes(closest.dist)} minutes (~${closest.dist.toFixed(2)} km)</div>`;
    document.getElementById('result').innerHTML = resultHtml;

    document.getElementById('schedule').innerHTML = buildScheduleTable(scheduleToday, onCampus);
  }

  // On page load, get geolocation and run main
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      main(pos.coords.latitude, pos.coords.longitude);
    }, err => {
      document.getElementById('status').textContent = "Location permission denied or unavailable.";
      document.getElementById('now').textContent = `(Unable to access location)`;
      document.getElementById('result').textContent = "Enable location to see next buses and walking times.";
      document.getElementById('schedule').innerHTML = buildScheduleTable(sundaySenate, true);
    });
  } else {
    document.getElementById('status').textContent = "Geolocation not supported on this device.";
  }
</script>
</body>
</html>
